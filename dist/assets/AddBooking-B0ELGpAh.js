import{j as e}from"./ui-B75sWwG2.js";import{u as J,r as n}from"./vendor-CNUPXUkP.js";import{u as a,B as p,C as H,c as b}from"./index-B1V6OKtR.js";import{L as S,I as R}from"./label-B0yGnVM1.js";import{S as U,a as _,b as q,c as K,d as w}from"./select-C-Bdqa44.js";import{C as G}from"./calendar-Dsk0swh7.js";import{P as Q,a as W,b as X}from"./popover-Yv56D1MC.js";import{C as Y}from"./checkbox-C55a1DVp.js";import{g as Z}from"./slotsApi-DFcxD0X-.js";import{a as ee}from"./venuesApi-P4toOt7F.js";import{A as se}from"./api-BW-Pu9pH.js";import{A as te,C as re,g as P}from"./utils-E33ow1TR.js";const pe=()=>{const u=J(),C=()=>{const s=new Date;return s.setHours(0,0,0,0),s},[L,f]=n.useState([]),[d,E]=n.useState(""),[l,F]=n.useState(C()),[j,y]=n.useState([]),[c,B]=n.useState(new Set),[h,$]=n.useState(""),[v,N]=n.useState(!1),[M,T]=n.useState(!1),[V,A]=n.useState(!1);n.useEffect(()=>{const s=localStorage.getItem("partnerId"),t=localStorage.getItem("isPartnerLoggedIn");if(!s||t!=="true"){a.error("Please login to access this page"),u("/partner/login");return}},[u]),n.useEffect(()=>{const s=localStorage.getItem("partnerId"),t=localStorage.getItem("isPartnerLoggedIn");if(!s||t!=="true")return;const o=localStorage.getItem("partnerVenues");if(o)try{const r=JSON.parse(o);f(r),N(!1);return}catch{}N(!0),(async()=>{try{const r=await ee(s);if(r.success&&r.data){const x=Array.isArray(r.data)?r.data:[r.data];f(x),localStorage.setItem("partnerVenues",JSON.stringify(x))}else a.error(r.message||"Failed to fetch venues"),f([])}catch(r){a.error(r instanceof Error?r.message:"Failed to load venues"),f([])}finally{N(!1)}})()},[u]),n.useEffect(()=>{if(!d||!l)return;(async()=>{T(!0);try{const t=P(l,"yyyy-MM-dd"),o=await Z(d,t);o.success&&o.data?(y(o.data.slots||[]),B(new Set)):(a.error(o.message||"Failed to fetch slots"),y([]))}catch(t){a.error(t instanceof Error?t.message:"Failed to load slots"),y([])}finally{T(!1)}})()},[d,l]);const z=s=>{const t=new Set(c);t.has(s)?t.delete(s):t.add(s),B(t)},O=async s=>{if(s.preventDefault(),!d){a.error("Please select a venue");return}if(!l){a.error("Please select a date");return}if(c.size===0){a.error("Please select at least one slot");return}if(!h||h.trim().length<10){a.error("Please enter a valid mobile number");return}A(!0);try{const t=localStorage.getItem("partnerId");if(!t){a.error("Partner ID not found. Please login again."),u("/partner/login");return}const o=P(l,"yyyy-MM-dd"),i=Array.from(c).map(m=>{const g=j.find(k=>(k.slotId||`${k.startTime}-${k.endTime}`)===m);if(!g)throw new Error(`Slot not found: ${m}`);return{slotId:g.slotId||m,startTime:g.startTime,endTime:g.endTime,price:g.price,isBooked:!0}}),r=h.trim(),x={partnerId:t,venueId:d,userId:r,date:o,slots:i.map(m=>({...m,isBooked:!0}))},D=await fetch(`${se}/api/bookings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)}),I=await D.json();D.ok&&I.success?(a.success(I.message||"Booking added successfully!"),u("/partner/dashboard")):a.error(I.message||"Failed to add booking")}catch(t){a.error(t instanceof Error?t.message:"Failed to add booking. Please try again.")}finally{A(!1)}};return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"max-w-3xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold mb-2",children:"Add New Booking"}),e.jsx("p",{className:"text-muted-foreground",children:"Create a booking for a user"})]}),e.jsxs(p,{variant:"outline",onClick:()=>u("/partner/dashboard"),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Back to Dashboard"]})]}),e.jsx(H,{className:"p-6 md:p-8",children:e.jsxs("form",{onSubmit:O,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"venue",className:"text-base font-semibold",children:"Select Venue *"}),e.jsxs(U,{value:d,onValueChange:E,disabled:v,children:[e.jsx(_,{id:"venue",className:"w-full",children:e.jsx(q,{placeholder:v?"Loading venues...":"Select a venue"})}),e.jsx(K,{children:v?e.jsx(w,{value:"loading",disabled:!0,children:"Loading venues..."}):L.length===0?e.jsx(w,{value:"no-venues",disabled:!0,children:"No venues available"}):L.map(s=>{const t=s.id||"";return t?e.jsx(w,{value:t,children:s.name},t):null})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-base font-semibold",children:"Select Date *"}),e.jsxs(Q,{children:[e.jsx(W,{asChild:!0,children:e.jsxs(p,{variant:"outline",className:b("w-full justify-start text-left font-normal",!l&&"text-muted-foreground"),children:[e.jsx(re,{className:"mr-2 h-4 w-4"}),l?P(l,"PPP"):"Pick a date"]})}),e.jsx(X,{className:"w-auto p-0",children:e.jsx(G,{mode:"single",selected:l,onSelect:s=>{if(s){const t=new Date(s);t.setHours(0,0,0,0),F(t)}},disabled:s=>{const t=C();return s<t},initialFocus:!0})})]})]}),d&&l&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-base font-semibold",children:"Select Slots *"}),M?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading slots..."})}):j.length===0?e.jsx("div",{className:"text-center py-8 border rounded-lg",children:e.jsx("p",{className:"text-muted-foreground",children:"No slots available for this date"})}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3 p-4 border rounded-lg max-h-96 overflow-y-auto",children:j.map(s=>{const t=s.slotId||`${s.startTime}-${s.endTime}`,o=c.has(t),i=s.booked||s.isBooked;return e.jsxs("label",{className:b("flex items-center space-x-2 p-3 border rounded-lg transition-colors",i?"bg-muted/50 border-muted-foreground/50 opacity-60 cursor-not-allowed grayscale":o?"bg-primary/10 border-primary cursor-pointer":"hover:bg-muted cursor-pointer"),onClick:r=>{if(i){r.preventDefault();return}},children:[e.jsx(Y,{checked:o,disabled:i,onCheckedChange:()=>{i||z(t)}}),e.jsxs("div",{className:"flex-1 pointer-events-none",children:[e.jsxs("p",{className:b("text-sm font-medium",i&&"text-muted-foreground line-through"),children:[s.startTime," - ",s.endTime]}),e.jsxs("p",{className:b("text-xs",i?"text-destructive font-medium":"text-muted-foreground"),children:["₹",s.price," ",i&&"• Booked"]})]})]},t)})}),c.size>0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[c.size," slot",c.size>1?"s":""," selected"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"mobile",className:"text-base font-semibold",children:"User Mobile Number *"}),e.jsx(R,{id:"mobile",type:"tel",placeholder:"Enter mobile number",value:h,onChange:s=>$(s.target.value.replace(/\D/g,"")),maxLength:10,required:!0})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>u("/partner/dashboard"),className:"flex-1",children:"Cancel"}),e.jsx(p,{type:"submit",className:"flex-1",disabled:V||!d||c.size===0,children:V?"Adding Booking...":"Add Booking"})]})]})})]})})})};export{pe as default};
